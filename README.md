# waifu2x-ncnn-vulkan-macos
As its long long name suggested.

### Acknowledgement
- [waifu2x-ncnn-vulkan](https://github.com/nihui/waifu2x-ncnn-vulkan)
- [ncnn](https://github.com/Tencent/ncnn)
- [Vulkan SDK](https://vulkan.lunarg.com/sdk/home)

### Build Instructions
Download lastest Vulkan SDK at [https://vulkan.lunarg.com/sdk/home](https://vulkan.lunarg.com/sdk/home).

At the time of this README.md wrote, 1.1.106.0 was the newest version for macOS.

```bash
brew install swig protobuf libomp

# remove all OpenMP lib but libomp.a to force a static link
export OPENMP_VER=7.0.0
rm -f /usr/local/Cellar/libomp/${OPENMP_VER}/lib/libgomp.dylib
rm -f /usr/local/Cellar/libomp/${OPENMP_VER}/lib/libgomp.a
rm -f /usr/local/Cellar/libomp/${OPENMP_VER}/lib/libiomp5.dylib
rm -f /usr/local/Cellar/libomp/${OPENMP_VER}/lib/libiomp5.a
rm -f /usr/local/Cellar/libomp/${OPENMP_VER}/lib/libomp.dylib

# build Xcode Toolchain with OpenMP support
export LLVM_VER=8.0.0
wget http://releases.llvm.org/${LLVM_VER}/llvm-${LLVM_VER}.src.tar.xz -O llvm-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/cfe-${LLVM_VER}.src.tar.xz -O cfe-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/compiler-rt-${LLVM_VER}.src.tar.xz -O compiler-rt-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/libcxx-${LLVM_VER}.src.tar.xz -O libcxx-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/libcxxabi-${LLVM_VER}.src.tar.xz -O libcxxabi-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/lld-${LLVM_VER}.src.tar.xz -O lld-${LLVM_VER}.src.tar.xz
# the debugserver requires code sign
# skip lldb if you wanna do that
# wget http://releases.llvm.org/${LLVM_VER}/lldb-${LLVM_VER}.src.tar.xz -O lldb-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/openmp-${LLVM_VER}.src.tar.xz -O openmp-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/polly-${LLVM_VER}.src.tar.xz -O polly-${LLVM_VER}.src.tar.xz
wget http://releases.llvm.org/${LLVM_VER}/clang-tools-extra-${LLVM_VER}.src.tar.xz -O clang-tools-extra-${LLVM_VER}.src.tar.xz

tar xf llvm-${LLVM_VER}.src.tar.xz
tar xf cfe-${LLVM_VER}.src.tar.xz && mv cfe-${LLVM_VER}.src clang
tar xf compiler-rt-${LLVM_VER}.src.tar.xz && mv compiler-rt-${LLVM_VER}.src compiler-rt
tar xf libcxx-${LLVM_VER}.src.tar.xz && mv ibcxx-${LLVM_VER}.src libcxx
tar xf libcxxabi-${LLVM_VER}.src.tar.xz && mv libcxxabi-${LLVM_VER}.src libcxxabi
tar xf lld-${LLVM_VER}.src.tar.xz && mv lld-${LLVM_VER}.src lld
# the debugserver requires code sign
# skip lldb if you wanna do that
# tar xf lldb-${LLVM_VER}.src.tar.xz && mv lldb-${LLVM_VER}.src lldb
tar xf openmp-${LLVM_VER}.src.tar.xz && mv openmp-${LLVM_VER}.src openmp 
tar xf polly-${LLVM_VER}.src.tar.xz && mv polly-${LLVM_VER}.src polly
tar xf clang-tools-extra-${LLVM_VER}.src.tar.xz && mv clang-tools-extra

cd llvm-8.0.0.src && mkdir -p build && cd build

# ninja is recommended to build LLVM
# get the latest ninja here
# https://github.com/ninja-build/ninja/releases/latest

cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_FFI=ON -DLLVM_CREATE_XCODE_TOOLCHAIN=ON -DLLVM_ENABLE_PROJECTS="clang;compiler-rt;libcxx;libcxxabi;lld;openmp;polly;clang-tools-extra;" ..

# <<< if you do want lldb to be built
#     append `lldb;` to the end of LLVM_ENABLE_PROJECTS
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_FFI=ON -DLLVM_CREATE_XCODE_TOOLCHAIN=ON -DLLVM_ENABLE_PROJECTS="clang;compiler-rt;libcxx;libcxxabi;lld;openmp;polly;clang-tools-extra;lldb;" ..
#     and make sure you have an identity
#     we need something like "Mac Developer: your@email.com (XXXXXXXXXX)"
security -q find-identity -v -p codesigning
#     then change to default code sign identity generated by CMake
vim build.ninja
#     just search for 'xcrun codesign' (without the quotes)
#     and you'll see 'xcrun codesign -s lldb_codesign'
#     now replace lldb_codesign with "Mac Developer: your@email.com (XXXXXXXXXX)" <- (WITH quotes)
#     save and quit
# >>> end of hacking ninja build file  

# caffee time / compile time
ninja

# we will only install the Xcode Toolchain 
sudo mkdir -p /usr/local/Toolchains
sudo chmod a+w /usr/local/Toolchains
ninja install-xcode-toolchain
sudo mv /usr/local/Toolchains/LLVM${LLVM_VER}.xctoolchain /Applications/Xcode.app/Contents/Developer/Toolchains

# copy arc related libraries from default toolchain to ours
sudo cp -rf /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/arc /Applications/Xcode.app/Contents/Developer/Toolchains/LLVM${LLVM_VER}.xctoolchain/usr/lib/

# clone this repo first
git clone --depth=1 https://github.com/BlueCocoa/waifu2x-ncnn-vulkan-macos

# download lastest Vulkan SDK
export VULKAN_SDK_VER="1.1.106.0"
wget https://sdk.lunarg.com/sdk/download/${VULKAN_SDK_VER}/mac/vulkansdk-macos-${VULKAN_SDK_VER}.tar.gz?Human=true -O vulkansdk-macos-${VULKAN_SDK_VER}.tar.gz
tar xf vulkansdk-macos-${VULKAN_SDK_VER}.tar.gz
rm -rf waifu2x-ncnn-vulkan-macos/waifu2x/VulkanSDK
mv vulkansdk-macos-${VULKAN_SDK_VER} waifu2x-ncnn-vulkan-macos/waifu2x/VulkanSDK

# clone Tencent/ncnn
git clone --depth=1 https://github.com/Tencent/ncnn ncnn
cp -rf ncnn/* waifu2x-ncnn-vulkan-macos/waifu2x/ncnn

# clone nihui/waifu2x-ncnn-vulkan
git clone --depth=1 https://github.com/nihui/waifu2x-ncnn-vulkan waifu2x-ncnn-vulkan
cp -rf waifu2x-ncnn-vulkan/* waifu2x-ncnn-vulkan-macos/waifu2x/waifu2x-ncnn-vulkan

# check your cmake installation
which cmake
# if it goes with /Applications/CMake.app/Contents/bin/cmake
# then you need to install it in /usr/local/bin via follow command
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install

# compile waifu2x-ncnn-vulkan-macos
# and the compiled application will be placed at `build/Release/waifu2x-gui.app`
cd waifu2x-ncnn-vulkan-macos
# you may need to open this project with Xcode in GUI mode to initialize Code Sign to your Apple ID
# and then you could continue with terminal
# using the toolchain we just built
export TOOLCHAINS=org.llvm.${LLVM_VER}
xcodebuild
```

### Notice
After the first compilation, you may set those flags in `Build Phases -> Run Script` to false to avoid recompile ncnn and regenerate shader.

![regenerate_shader](regenerate_shader.png)

![recompile_ncnn](recompile_ncnn.png)

### Screenshot

![screenshot](screenshot.png)
